app-id: com.github.FogStripper
runtime: org.kde.Platform
runtime-version: '6.6'
sdk: org.kde.Sdk
command: fogstripper-launcher.sh
finish-args:
  # Permissões necessárias
  - --share=ipc
  - --socket=fallback-x11
  - --socket=wayland
  - --device=dri # Acesso à GPU
  - --filesystem=home # Acesso aos arquivos do usuário

modules:
  # 1. Dependências do sistema

  - name: potrace
    buildsystem: autotools
    sources:
      - type: archive
        url: https://potrace.sourceforge.net/download/1.16/potrace-1.16.tar.gz
        sha256: be8248a17dedd6ccbaab2fcc45835bb0502d062e40fbded3bc56028ce5eb7acc

  # 2. Módulo Python principal que constrói o venv unificado
  - name: fogstripper-python-venv
    buildsystem: simple
    build-commands:
      # Caminho de instalação dentro do sandbox do Flatpak
      - INSTALL_PREFIX=/app

      # --- Criação e Instalação do Venv Unificado ---
      - python3 -m venv $INSTALL_PREFIX/venv
      - $INSTALL_PREFIX/venv/bin/pip install --no-cache-dir --upgrade pip setuptools wheel

      # Instalação do PyTorch CPU (Flatpak geralmente não tem acesso fácil ao CUDA host environment, vamos de CPU safe)
      - $INSTALL_PREFIX/venv/bin/pip install --no-cache-dir --index-url https://download.pytorch.org/whl/cpu torch==1.13.1 torchvision==0.14.1

      # Instalação das dependências gerais
      - $INSTALL_PREFIX/venv/bin/pip install --no-cache-dir -r requirements.txt

      # --- Copiando os arquivos da aplicação ---
      - mkdir -p $INSTALL_PREFIX/bin
      - mkdir -p $INSTALL_PREFIX/src
      - cp -r src/* $INSTALL_PREFIX/src/
      - cp -r assets $INSTALL_PREFIX/assets

      # Launcher script
      - cp fogstripper-launcher.sh $INSTALL_PREFIX/bin/
      - chmod +x $INSTALL_PREFIX/bin/fogstripper-launcher.sh

      # --- Gerando o config.json para o ambiente Flatpak ---
      - |
        cat > "$INSTALL_PREFIX/src/config.json" << EOL
        {
            "PYTHON_REMBG": "$INSTALL_PREFIX/venv/bin/python3",
            "PYTHON_UPSCALE": "$INSTALL_PREFIX/venv/bin/python3",
            "REMBG_SCRIPT": "$INSTALL_PREFIX/src/workers/worker_rembg.py",
            "UPSCALE_SCRIPT": "$INSTALL_PREFIX/src/workers/worker_upscale.py",
            "EFFECTS_SCRIPT": "$INSTALL_PREFIX/src/workers/worker_effects.py",
            "BACKGROUND_SCRIPT": "$INSTALL_PREFIX/src/workers/worker_background.py"
        }
        EOL
    sources:
      - type: dir
        path: . # O diretório atual do projeto
